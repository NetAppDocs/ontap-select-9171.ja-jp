---
sidebar: sidebar 
permalink: concept_stor_hwraid_local.html 
keywords: ontap select, hardware raid, performance boost, protection 
summary: ハードウェアRAIDコントローラが利用可能な場合、 ONTAP SelectはRAIDサービスをハードウェアコントローラに移行することで、書き込みパフォーマンスの向上と物理ドライブ障害からの保護の両方を実現します。その結果、 ONTAP Selectクラスタ内のすべてのノードのRAID保護は、 ONTAPソフトウェアRAIDではなく、ローカルに接続されたRAIDコントローラによって提供されます。 
---
= ONTAP Selectローカル接続ストレージ向けハードウェア RAID サービス
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
ハードウェアRAIDコントローラが利用可能な場合、 ONTAP SelectはRAIDサービスをハードウェアコントローラに移行することで、書き込みパフォーマンスの向上と物理ドライブ障害からの保護の両方を実現します。その結果、 ONTAP Selectクラスタ内のすべてのノードのRAID保護は、 ONTAPソフトウェアRAIDではなく、ローカルに接続されたRAIDコントローラによって提供されます。


NOTE: ONTAP Selectデータアグリゲートは、物理RAIDコントローラが基盤となるドライブにRAIDストライピングを提供するため、RAID 0を使用するように構成されています。他のRAIDレベルはサポートされていません。



== ローカル接続ストレージの RAID コントローラ構成

ONTAP Selectにバックアップストレージを提供するローカル接続ディスクはすべて、RAIDコントローラの背後に配置する必要があります。ほとんどのコモディティサーバには、複数の価格帯のRAIDコントローラオプションが用意されており、それぞれ機能レベルが異なります。コントローラに課せられた一定の最小要件を満たす限り、これらのオプションを可能な限り多くサポートすることが目的です。


NOTE: ハードウェアRAID構成を使用しているONTAP Select VMから仮想ディスクをデタッチすることはできません。ディスクのデタッチは、ソフトウェアRAID構成を使用しているONTAP Select VMでのみサポートされます。見るlink:task_adm_replace_drives_swraid.html["ONTAP SelectソフトウェアRAID構成で故障したドライブを交換する"]詳細についてはこちらをご覧ください。

ONTAP Selectディスクを管理する RAID コントローラは、次の要件を満たしている必要があります。

* ハードウェア RAID コントローラには、バッテリ バックアップ ユニット (BBU) またはフラッシュ バックアップ書き込みキャッシュ (FBWC) が搭載され、12Gbps のスループットをサポートしている必要があります。
* RAID コントローラは、少なくとも 1 つまたは 2 つのディスク障害に耐えられるモード (RAID 5 および RAID 6) をサポートする必要があります。
* ドライブ キャッシュを無効に設定する必要があります。
* 書き込みポリシーは、BBU またはフラッシュ障害時に書き込みを続行するためのフォールバックを備えたライトバック モードに設定する必要があります。
* 読み取りの I/O ポリシーをキャッシュに設定する必要があります。


ONTAP Selectにバッキングストレージを提供するローカル接続ディスクはすべて、RAID 5またはRAID 6を実行するRAIDグループに配置する必要がありますドライブおよびSSDの場合、最大24台のドライブで構成されるRAIDグループを使用することで、 ONTAPは受信読み取り要求をより多くのディスクに分散させるメリットを享受できます。これにより、パフォーマンスが大幅に向上します。SAS/SSD構成では、単一LUN構成と複数LUN構成のパフォーマンステストを実施しました。大きな違いは見られませんでした。そのため、簡潔にするために、 NetApp構成のニーズを満たすために必要な最小限のLUNを作成することを推奨しています。

NL-SASおよびSATAドライブには、異なるベストプラクティスが適用されます。パフォーマンス上の理由から、ディスクの最小数は依然として8台ですが、RAIDグループのサイズは12台以下に抑えてください。NetAppNetApp、RAIDグループごとに1つのスペアディスクを使用することを推奨していますが、すべてのRAIDグループにグローバルスペアディスクを使用することもできます。例えば、RAIDグループ3つごとにスペアディスクを2つ使用し、各RAIDグループを8～12台のドライブで構成することができます。


NOTE: 古い ESX リリースの最大エクステントおよびデータストア サイズは 64 TB であり、これらの大容量ドライブによって提供される合計生容量をサポートするために必要な LUN の数に影響する可能性があります。



== RAIDモード

多くのRAIDコントローラは最大3つの動作モードをサポートしており、それぞれが書き込み要求のデータパスに大きな違いをもたらします。これらの3つのモードは以下のとおりです。

* ライトスルー。すべての着信 I/O 要求は RAID コントローラ キャッシュに書き込まれ、その後すぐにディスクにフラッシュされてから、ホストに要求の確認が返されます。
* ライトアラウンド。すべての着信 I/O 要求は RAID コントローラ キャッシュを回避してディスクに直接書き込まれます。
* ライトバック。すべての受信I/O要求はコントローラのキャッシュに直接書き込まれ、即座にホストに確認応答が返されます。データブロックはコントローラを介して非同期的にディスクにフラッシュされます。


ライトバックモードは最短のデータパスを提供し、ブロックがキャッシュに入った直後にI/O確認応答が行われます。このモードは、読み取り/書き込み混合ワークロードにおいて、最も低いレイテンシと最高のスループットを実現します。ただし、BBUまたは不揮発性フラッシュテクノロジーがない場合、このモードで動作中にシステムに電源障害が発生すると、データが失われるリスクがあります。

ONTAP Selectにはバッテリバックアップまたはフラッシュユニットが必要です。そのため、この種の障害が発生した場合でも、キャッシュされたブロックがディスクにフラッシュされることが保証されます。そのため、RAIDコントローラをライトバックモードに設定する必要があります。



== ONTAP SelectとOS間で共有されるローカルディスク

最も一般的なサーバー構成は、ローカルに接続されたすべてのスピンドルが単一のRAIDコントローラの背後に配置される構成です。少なくとも2つのLUNをプロビジョニングする必要があります。1つはハイパーバイザー用、もう1つはONTAP Select VM用です。

例えば、6台の内蔵ドライブと1台のSmartアレイP420i RAIDコントローラーを搭載したHP DL380 g8を考えてみましょう。すべての内蔵ドライブはこのRAIDコントローラーによって管理され、システムには他のストレージは存在しません。

次の図は、この構成を示しています。この例では、システム上に他のストレージが存在しないため、ハイパーバイザーはONTAP Selectノードとストレージを共有する必要があります。

*RAID管理スピンドルのみを使用したサーバーLUN構成*

image:ST_08.jpg["RAID管理スピンドルのみを使用したサーバーLUN構成"]

ONTAP Selectと同じRAIDグループからOS LUNをプロビジョニングすることで、ハイパーバイザーOS（および同じストレージからプロビジョニングされるクライアントVM）はRAID保護のメリットを享受できます。この構成により、単一のドライブ障害によってシステム全体がダウンすることを防ぎます。



== ローカルディスクはONTAP SelectとOS間で分割されます

サーバーベンダーが提供するもう1つの構成は、複数のRAIDまたはディスクコントローラを使用してシステムを構成することです。この構成では、1組のディスクが1つのディスクコントローラによって管理されます。このディスクコントローラはRAIDサービスを提供する場合と提供しない場合があります。もう1組のディスクは、RAID 5/6サービスを提供できるハードウェアRAIDコントローラによって管理されます。

この構成では、RAID 5/6サービスを提供できるRAIDコントローラの背後にあるスピンドルセットを、 ONTAP Select VM専用にする必要があります。管理対象のストレージ容量全体に応じて、ディスクスピンドルを1つ以上のRAIDグループと1つ以上のLUNに構成する必要があります。これらのLUNは、1つ以上のデータストアを作成するために使用され、すべてのデータストアはRAIDコントローラによって保護されます。

次の図に示すように、最初のディスク セットはハイパーバイザー OS とONTAPストレージを使用していないクライアント VM 用に予約されています。

*RAID/非RAID混合システムにおけるサーバーLUN構成*

image:ST_09.jpg["混合RAID/非RAIDシステム上のサーバーLUN構成"]



== 複数のLUN

単一RAIDグループ/単一LUN構成を変更する必要があるケースが2つあります。NL-SASまたはSATAドライブを使用する場合、RAIDグループのサイズは12ドライブ以下にする必要があります。また、単一のLUNが、基盤となるハイパーバイザーのストレージ制限（個々のファイルシステムエクステントの最大サイズ、またはストレージプール全体の最大サイズ）を超える可能性があります。その場合、ファイルシステムを正常に作成するには、基盤となる物理ストレージを複数のLUNに分割する必要があります。



== VMware vSphere 仮想マシンのファイルシステムの制限

一部のバージョンの ESX では、データストアの最大サイズは 64 TB です。

サーバーに64TBを超えるストレージが接続されている場合、64TB未満の複数のLUNをプロビジョニングする必要がある場合があります。SATA/NL-SASドライブのRAID再構築時間を短縮するために複数のRAIDグループを作成すると、複数のLUNがプロビジョニングされることになります。

複数のLUNが必要な場合、これらのLUNのパフォーマンスが同等かつ一貫していることを確認することが重要な考慮事項です。これは、すべてのLUNを単一のONTAPアグリゲートで使用する場合に特に重要です。また、1つ以上のLUNのサブセットのパフォーマンスプロファイルが明確に異なる場合は、これらのLUNを別のONTAPアグリゲートに分離することを強くお勧めします。

複数のファイルシステムエクステントを使用して、データストアの最大サイズまで単一のデータストアを作成できます。ONTAPONTAP Selectライセンスが必要となる容量を制限するには、クラスタのインストール時に容量上限を指定してください。この機能により、 ONTAP Selectはデータストア内のスペースのサブセットのみを使用（つまり、ライセンスが必要）できます。

あるいは、単一のLUNに単一のデータストアを作成することから始めることもできます。より大きなONTAP Select容量ライセンスを必要とする追加のスペースが必要な場合は、そのスペースを同じデータストアにエクステントとして追加できます（データストアの最大サイズまで）。最大サイズに達した後は、新しいデータストアを作成してONTAP Selectに追加できます。どちらのタイプの容量拡張操作もサポートされており、 ONTAP Deployのストレージ追加機能を使用して実行できます。各ONTAP Selectノードは、最大400TBのストレージをサポートするように設定できます。複数のデータストアから容量をプロビジョニングするには、2段階のプロセスが必要です。

初期クラスタ作成では、初期データストアのスペースの一部または全部を使用するONTAP Selectクラスタを作成できます。次のステップでは、追加のデータストアを使用して、必要な総容量に達するまで、1つ以上の容量追加操作を実行します。この機能については、以下のセクションで詳しく説明します。link:concept_stor_capacity_inc.html["ストレージ容量を増やす"] 。


NOTE: VMFS のオーバーヘッドはゼロではありません (VMware KB 1001618 を参照)。データストアによって空きとして報告された領域全体を使用しようとすると、クラスター作成操作中に誤ったエラーが発生します。

各データストアには2%のバッファが未使用のまま残されます。このスペースはONTAP Selectでは使用されないため、容量ライセンスは必要ありません。ONTAPONTAPは、容量上限が指定されていない限り、バッファの正確なギガバイト数を自動的に計算します。容量上限が指定されている場合は、まずそのサイズが適用されます。容量上限のサイズがバッファサイズの範囲内にある場合、クラスタの作成は失敗し、容量上限として使用できる正しい最大サイズパラメータを示すエラーメッセージが表示されます。

[listing]
----
“InvalidPoolCapacitySize: Invalid capacity specified for storage pool “ontap-select-storage-pool”, Specified value: 34334204 GB. Available (after leaving 2% overhead space): 30948”
----
VMFS 6 は、新規インストールと、既存のONTAP Deploy またはONTAP Select VM の Storage vMotion 操作のターゲットの両方でサポートされています。

VMwareは、VMFS 5からVMFS 6へのインプレースアップグレードをサポートしていません。そのため、VMをVMFS 5データストアからVMFS 6データストアに移行できる唯一のメカニズムはStorage vMotionです。ただし、 ONTAP SelectおよびONTAP DeployによるStorage vMotionのサポートは拡張され、VMFS 5からVMFS 6への移行という特定の目的以外にも、様々なシナリオに対応できるようになりました。



== ONTAP Select仮想ディスク

ONTAP Selectは、1つ以上のストレージプールからプロビジョニングされた仮想ディスクセットをONTAPに提供します。ONTAPには、ONTAPディスクとして扱う仮想ディスクセットが提供され、ストレージスタックの残りの部分はハイパーバイザーによって抽象化されます。次の図は、この関係をより詳細に示しており、物理RAIDコントローラ、ハイパーバイザー、およびONTAP Select VMの関係を強調しています。

* RAIDグループとLUNの設定は、サーバーのRAIDコントローラソフトウェアから行います。VSANまたは外部アレイを使用する場合は、この設定は必要ありません。
* ストレージ プールの構成はハイパーバイザー内から行われます。
* 仮想ディスクは、個々の VM によって作成され、所有されます。この例では、 ONTAP Selectによって作成され、所有されます。


*仮想ディスクから物理ディスクへのマッピング*

image:ST_12.jpg["仮想ディスクから物理ディスクへのマッピング"]



== 仮想ディスクのプロビジョニング

より効率的なユーザーエクスペリエンスを実現するために、 ONTAP Select管理ツールであるONTAP Deployは、関連付けられたストレージプールから仮想ディスクを自動的にプロビジョニングし、 ONTAP Select仮想マシンに接続します。この処理は、初期セットアップ時とストレージ追加操作時の両方で自動的に実行されます。ONTAP SelectノードがHAペアの一部である場合、仮想ディスクは自動的にローカル ストレージ プールとミラー ストレージ プールに割り当てられます。

ONTAP Selectは、基盤の接続ストレージを同じサイズの複数の仮想ディスク（いずれも16TB以下）に分割します。ONTAP Selectノードが HA ペアの一部である場合、各クラスタ ノードに少なくとも 2 つの仮想ディスクが作成され、ミラー化されたアグリゲート内で使用されるローカル プレックスとミラー プレックスに割り当てられます。

例えば、 ONTAP Selectに31TB（VMの導入とシステムディスクおよびルートディスクのプロビジョニング後に残る容量）のデータストアまたはLUNを割り当てることができます。その後、約7.75TBの仮想ディスクが4つ作成され、適切なONTAPローカルプレックスとミラープレックスに割り当てられます。


NOTE: ONTAP Select VMに容量を追加すると、VMDKのサイズが異なる場合があります。詳細については、link:concept_stor_capacity_inc.html["ストレージ容量を増やす"] 。FASシステムとは異なり、同じアグリゲート内に異なるサイズのVMDKを混在させることができます。はこれらのVMDK間でRAID 0ストライプを使用するため、各VMDKのサイズに関係なく、すべてのスペースを最大限に活用できます。



== 仮想化NVRAM

NetApp FASシステムは、従来、不揮発性フラッシュメモリを搭載した高性能な物理NVRAM PCIカードを搭載しています。このカードは、 ONTAPがクライアントへの書き込みを即座に確認応答することで、書き込みパフォーマンスを大幅に向上させます。また、デステージングと呼ばれるプロセスで、変更されたデータブロックを低速なストレージメディアに戻すスケジュールを設定することもできます。

コモディティシステムでは通常、このような機器は搭載されていません。そのため、このNVRAMカードの機能は仮想化され、 ONTAP Selectシステムブートディスク上のパーティションに配置されています。そのため、インスタンスのシステム仮想ディスクの配置は非常に重要です。また、この製品では、ローカル接続ストレージ構成において、耐障害性の高いキャッシュを備えた物理RAIDコントローラが必須となっています。

NVRAMは専用のVMDKに配置されます。NVRAMを専用のVMDKに分割することで、 ONTAP Select VMはvNVMeドライバを使用してNVRAM VMDKと通信できるようになります。また、 ONTAP Select VMはESX 6.5以降と互換性のあるハードウェアバージョン13を使用する必要があります。



== データパスの説明: NVRAMとRAIDコントローラ

仮想化されたNVRAMシステム パーティションと RAID コントローラ間の相互作用は、書き込み要求がシステムに入るときに実行されるデータ パスを調べることによって最もよくわかります。

ONTAP Select VMへの書き込み要求は、VMのNVRAMパーティションを対象とします。仮想化レイヤーでは、このパーティションはONTAP Select ONTAP Selectシステムディスク内に存在します。物理レイヤーでは、これらの要求は、基盤となるスピンドルを対象としたすべてのブロック変更と同様に、ローカルRAIDコントローラにキャッシュされます。そして、書き込みの確認応答がホストに返されます。

この時点で、物理的にはブロックはRAIDコントローラのキャッシュ内に存在し、ディスクへのフラッシュを待機しています。論理的には、ブロックはNVRAM内に存在し、適切なユーザーデータディスクへのデステージを待機しています。

変更されたブロックはRAIDコントローラのローカルキャッシュに自動的に保存されるため、 NVRAMパーティションへの書き込みは自動的にキャッシュされ、定期的に物理ストレージメディアにフラッシュされます。これは、 NVRAMの内容をONTAPデータディスクに定期的にフラッシュすることと混同しないでください。これら2つのイベントは無関係であり、異なる時間と頻度で発生します。

次の図は、書き込みが通過するI/Oパスを示しています。物理層（RAIDコントローラのキャッシュとディスクで表されます）と仮想層（VMのNVRAMとデータ仮想ディスクで表されます）の違いが明確に示されています。


NOTE: NVRAM VMDK上で変更されたブロックはローカルRAIDコントローラのキャッシュにキャッシュされますが、このキャッシュはVM構成やその仮想ディスクを認識しません。システム上の変更されたすべてのブロックがキャッシュに保存されますが、 NVRAMはその一部にすぎません。これには、ハイパーバイザーが同じバックエンドスピンドルからプロビジョニングされている場合、ハイパーバイザー宛の書き込み要求も含まれます。

* ONTAP Select VMへの書き込み*

image:ST_13.jpg["ONTAP Select VMへの書き込み"]


NOTE: NVRAMパーティションは専用のVMDKに分離されています。このVMDKは、ESXバージョン6.5以降で利用可能なvNVMEドライバを使用して接続されます。この変更は、RAIDコントローラキャッシュのメリットを享受できないソフトウェアRAIDを備えたONTAP Selectインストールにおいて特に重要です。
